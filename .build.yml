image: ubuntu/bionic
packages:
    - curl
    - rsync
    - libssl-dev
    - pkg-config
sources:
    - git@git.sr.ht:~nerosnm/hatysa
environment:
  deploy: ***REMOVED***
secrets:
    - d6f8e1e6-21ea-4923-8a06-66f80ceba86a
tasks:
    - install: |
        curl https://sh.rustup.rs -sSf | sh -s -- -y
        source ~/.cargo/env
        rustup install stable
    - build: |
        cd hatysa
        source ~/.cargo/env
        cargo build --release
    - deploy: |
        cd hatysa
        echo "StrictHostKeyChecking=no" >> ~/.ssh/config
        head=$(git rev-parse HEAD)
        if [ $head = "$(git rev-parse origin/master)" ]; then \
            echo "Deploying from branch master on commit $head to ***REMOVED***"
            rsync -rP --delete target/release/hatysa $deploy:***REMOVED***
            ssh $deploy 'sudo systemctl restart ***REMOVED***'
        else
            echo "Not deploying on commit $head"
            complete-build
        fi
